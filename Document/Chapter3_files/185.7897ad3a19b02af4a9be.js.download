(window.webpackJsonp=window.webpackJsonp||[]).push([[185],{hWRP:function(e,t,r){"use strict";r.r(t);var n,a=r("Kxc7"),s=r("uOxu"),i=Object(s.getLogger)("Alerts.Price.RequestCache");function o(e,t){void 0===t&&(t=""),i.logDebug(e+" "+t)}!function(e){var t={};function r(e){var r=a(e);return t[r]&&o("got from cache",r),t[r]?t[r].self:null}function n(e,r){void 0===r&&(r=!1);var n=a(e),s=t[n];if(s)if(r)s.clearCacheTimeoutId&&clearTimeout(s.clearCacheTimeoutId),delete t[n],o("removed immediately",n);else{s.clearCacheTimeoutId=setTimeout((function(){delete t[n],o("removed timeout",n)}),5e3)}}function a(e){return JSON.stringify(e)}e.set=function(e,s){var i=a(e);r(e)&&n(e,!0),t[i]={self:s},o("added",i),s.then((function(t){return n(e),t})).catch((function(t){return n(e,!0),t}))},e.get=r,e.isCachable=function(e){return"list_alerts"===e.method||"list_events"===e.method}}(n||(n={}));var u,c=r("0waE"),l=Object(s.getLogger)("Alerts.Price.MergedGetAlertsRequrest");function d(e,t){var r=t?JSON.stringify(t):"";l.logDebug(e+" "+r)}!function(e){var t={},r=null,n=null;function a(e){delete t[e],Object.keys(t).length||(n=null,r=null)}e.isMergable=function(e){return"get_alert"===e.method||"get_alerts"===e.method},e.mergeRequest=function(e){var s=Object(c.guid)(),i=new Promise((function(t,a){d("personal promise - creating",e),function(e){var t=[];"id"in e.params?t=[e.params.id]:"ids"in e.params&&(t=e.params.ids);n?n.params.ids=n.params.ids.concat(t):n={method:"get_alerts",params:{ids:t}}}(e),function(){r||(d("merged promise - creating"),(r=new Promise((function(e,t){setTimeout((function(){n?(d("send request to server - timeout"),_(n).then((function(t){e(t)})).catch(t)):t("No data to send request")}),500)}))).then((function(e){return d("merged promise - resolved")})),r.catch((function(e){return d("merged promise - rejected")})));return r}().then((function(r){var n=function(e,t){var r=t.alerts||[],n=null;if("get_alert"===e.method){var a=r.filter((function(t){return t.id===e.params.id}))[0];a&&(n={alert:a})}else if("get_alerts"===e.method){for(var s=e.params.ids,i=[],o=s.length-1;o>=0;o--)for(var u=s[o],c=r.length-1;c>=0;c--){var l=r[c];if(l.id===u){i.push(l);break}}i.length&&(n={alerts:i})}return n}(e,r);n?(d("personal promise - resolved",e),t(n)):(d("personal promise - rejected",e),a("not_exists"))})).catch(a)}));return i.then((function(e){return a(s),e})).catch((function(e){return a(s),e})),function(e,r){t[e]=r}(s,i),i}}(u||(u={}));var m=r("xlbu"),f=r("BHQF");r.d(t,"sendRequest",(function(){return v})),r.d(t,"sendRequestImmediately",(function(){return _}));var p=Object(s.getLogger)("Alerts.Price.Request"),g=window.initData.price_alerts_url||"";a.enabled("alerts")&&!g&&p.logError("Url not passed");var h=new Set(["create_alert","stop_alert","stop_all","restart_alert","restart_all","delete_alert","delete_all","delete_events","update_extra","get_offline_events"]);function v(e){if(e.method&&h.has(e.method)){var t=Object.assign({},e.params);e.params&&"extra"in e.params&&(t.extra=JSON.parse(e.params.extra)),p.logNormal(JSON.stringify({m:e.method,
p:t}))}if(u.isMergable(e))return u.mergeRequest(e);if(n.isCachable(e)){var r=n.get(e);return r||(r=_(e),n.set(e,r)),r}return _(e)}function _(e){var t=e.method,r={body:JSON.stringify({m:t,p:e.params}),credentials:"include",method:"POST",headers:e.headers},n=(new Date).getTime();if(!g)return Promise.reject("no_alerts_url");var a=window.user&&window.user.username?g+"?log_username="+window.user.username:g;return Object(f.fetch)(a,r,{logBodyOnError:!0}).then((function(e){m.telemetry.sendReport("alerts","api_http_status",{value:e.status});var t=(new Date).getTime()-n;return m.telemetry.sendReport("alerts","api_time_frame",{value:t}),e.json()})).then((function(e){return"success"===e.m?e.p:"error"===e.m?Promise.reject(e.p.reason||"Unexpected server response"):Promise.reject("Unexpected server response")})).catch((function(e){return e instanceof Error?Promise.reject("Failed to fetch price-alerts: "+e):Promise.reject(e)}))}}}]);